{% extends "base.html" %}

{% block title %}Analysis Results - {{ super() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5">
                <i class="fas fa-chart-line"></i> Analysis Results
            </h1>
            <div>
                <a href="{{ url_for('view_report', report_id=report_id) }}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-eye"></i> View Full Report
                </a>
                <a href="{{ url_for('download_report', report_id=report_id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-download"></i> Download JSON
                </a>
            </div>
        </div>

        <!-- Classification Result -->
        <div class="card mb-4 {% if report.classification_result.is_fake %}border-danger{% else %}border-success{% endif %}">
            <div class="card-header {% if report.classification_result.is_fake %}bg-danger text-white{% else %}bg-success text-white{% endif %}">
                <h3 class="card-title mb-0">
                    <i class="fas {% if report.classification_result.is_fake %}fa-exclamation-triangle{% else %}fa-check-circle{% endif %}"></i>
                    Classification Result
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="{% if report.classification_result.is_fake %}fake-status{% else %}legitimate-status{% endif %}">
                            {% if report.classification_result.is_fake %}
                                <i class="fas fa-times-circle"></i> FAKE/MALICIOUS
                            {% else %}
                                <i class="fas fa-check-circle"></i> LEGITIMATE
                            {% endif %}
                        </h4>
                        <p><strong>Confidence:</strong> {{ "%.2f"|format(report.classification_result.confidence) }}</p>
                        <p><strong>Method:</strong> {{ report.classification_result.method|title }}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Probability Scores:</h5>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-danger" style="width: {{ (report.classification_result.probability_scores.fake * 100)|round }}%">
                                Fake: {{ "%.1f"|format(report.classification_result.probability_scores.fake * 100) }}%
                            </div>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: {{ (report.classification_result.probability_scores.legitimate * 100)|round }}%">
                                Legitimate: {{ "%.1f"|format(report.classification_result.probability_scores.legitimate * 100) }}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- APK Information -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> APK Information
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>App Name:</strong> {{ report.apk_information.app_name }}</p>
                        <p><strong>Package Name:</strong> <code>{{ report.apk_information.package_name }}</code></p>
                        <p><strong>Version:</strong> {{ report.apk_information.version_name }} ({{ report.apk_information.version_code }})</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>MD5:</strong> <code>{{ report.apk_information.file_hashes.md5[:16] }}...</code></p>
                        <p><strong>SHA256:</strong> <code>{{ report.apk_information.file_hashes.sha256[:16] }}...</code></p>
                        <p><strong>Analysis Time:</strong> {{ report.analysis_metadata.timestamp[:19] }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle"></i> Risk Assessment
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="display-4 risk-{{ report.risk_assessment.risk_level.lower() }}">
                                {{ "%.0f"|format(report.risk_assessment.overall_risk_score) }}
                            </div>
                            <h5 class="risk-{{ report.risk_assessment.risk_level.lower() }}">
                                {{ report.risk_assessment.risk_level }}
                            </h5>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h5>Risk Factors:</h5>
                        {% if report.risk_assessment.risk_factors %}
                            {% for factor in report.risk_assessment.risk_factors %}
                                <div class="alert alert-{% if factor.severity == 'HIGH' %}danger{% elif factor.severity == 'MEDIUM' %}warning{% else %}info{% endif %} py-2">
                                    <strong>{{ factor.category }} ({{ factor.severity }}):</strong> {{ factor.description }}
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No significant risk factors identified.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Permissions Analysis -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-key"></i> Permissions Analysis
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="display-6">{{ report.static_analysis.permissions.total_count }}</div>
                            <p>Total Permissions</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="display-6 text-danger">{{ report.static_analysis.permissions.suspicious_count }}</div>
                            <p>Suspicious Permissions</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="display-6">{{ report.static_analysis.components.activities }}</div>
                            <p>Activities</p>
                        </div>
                    </div>
                </div>
                
                {% if report.static_analysis.permissions.suspicious_permissions %}
                    <h5 class="mt-4">Suspicious Permissions:</h5>
                    <div class="row">
                        {% for perm in report.static_analysis.permissions.suspicious_permissions %}
                            <div class="col-md-6 mb-2">
                                <span class="badge bg-danger">{{ perm }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Recommendations -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-lightbulb"></i> Security Recommendations
                </h4>
            </div>
            <div class="card-body">
                {% for rec in report.recommendations %}
                    <div class="alert alert-{% if rec.priority == 'CRITICAL' %}danger{% elif rec.priority == 'HIGH' %}warning{% elif rec.priority == 'MEDIUM' %}info{% else %}light{% endif %}">
                        <h6 class="alert-heading">
                            <i class="fas fa-{% if rec.priority == 'CRITICAL' %}exclamation-triangle{% elif rec.priority == 'HIGH' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                            {{ rec.priority }}: {{ rec.action }}
                        </h6>
                        <p class="mb-0">{{ rec.description }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mb-4">
            <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-upload"></i> Analyze Another APK
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add any interactive features here
    console.log('Analysis results loaded');
});
</script>
{% endblock %}
